---
up:
  - "[[SpringBoot 課程描述]]"
  - "[[监控]]"
---
> 端点描述了被监控的信息，除了系统默认的指标，还可以自行添加显示的指标，下面就通过3种不同的端点的指标自定义方式来学习端点信息的二次开发。

---

# **INFO端点**

> info端点描述了当前应用的基本信息，可以通过两种形式快速配置info端点的信息

## 配置形式

在yml文件中通过设置info节点的信息就可以快速配置端点信息

```yaml
spring:
  # Spring Boot Admin 监控服务器端地址
  boot:
    admin:
      client:
        url: http://localhost:8080

management:
  endpoints:    # 全部端点的配置
    web:
      exposure:
        include: "*"  # 暴露所有端点
  info:
    env:
      enabled: true # 讓 info.* 屬性出現在 /actuator/info

#添加描述
info:
  appName: @project.artifactId@
  version: @project.version@
  company: 传智教育
  author: itheima

server:
  port: 8083
```

  配置完毕后，对应信息显示在监控平台上

![[监控/附件/image-20220301174133248.png]]

  也可以通过请求端点信息路径获取对应json信息

![[监控/附件/image-20220301174241310.png]]

## 编程形式

  通过配置的形式只能添加固定的数据，如果需要动态数据还可以通过配置bean的方式为info端点添加信息，此信息与配置信息共存

```yml
spring:
  # Spring Boot Admin 监控服务器端地址
  boot:
    admin:
      client:
        url: http://localhost:8080

management:
  endpoints:    # 全部端点的配置
    web:
      exposure:
        include: "*"  # 暴露所有端点

server:
  port: 8083
```

```JAVA
@Component
public class InfoConfig implements InfoContributor {
    private final long startTime = ManagementFactory.getRuntimeMXBean().getStartTime();

    @Override
    public void contribute(Info.Builder builder) {
        long uptimeMs = System.currentTimeMillis() - startTime;

        builder.withDetail("app", Map.of(
                "name", "Test Application",
                "uptime", Duration.ofMillis(uptimeMs).toString()
        ));

        builder.withDetail("company", Map.of(
                "name", "ACME",
                "owner", "SIAO"
        ));
    }
}
```

---
# **Health端点** 這

​health端点描述当前应用的运行健康指标，即应用的运行是否成功。通过编程的形式可以扩展指标信息。

```yml
spring:
  # Spring Boot Admin 监控服务器端地址
  boot:
    admin:
      client:
        url: http://localhost:8080

management:
  endpoint:
    health:
      show-details: always
  endpoints:    # 全部端点的配置
    web:
      exposure:
        include: "*"  # 暴露所有端点

server:
  port: 8083
```

```JAVA
@Component
public class HealthConfig extends AbstractHealthIndicator {
    @Override
    protected void doHealthCheck(Health.Builder builder) throws Exception {
        boolean condition = true;
        if(condition) {
            builder.status(Status.UP);					//设置运行状态为启动状态
            builder.withDetail("runTime", System.currentTimeMillis());
            Map infoMap = new HashMap();
            infoMap.put("buildTime", "2006");
            builder.withDetails(infoMap);
        }else{
            builder.status(Status.OUT_OF_SERVICE);		//设置运行状态为不在服务状态
            builder.withDetail("上线了吗？","你做梦");
        }
    }
}
```

​当任意一个组件状态不为UP时，整体应用对外服务状态为非UP状态。

![[监控/附件/image-20220301174751845.png]]

---
# **Metrics 端点**

​metrics端点描述了性能指标，除了系统自带的监控性能指标，还可以自定义性能指标。

```JAVA
@Service  
public class BookServiceImpl extends ServiceImpl<BookMapper, Book> implements IBookService {  
    @Autowired  
    private BookMapper bookMapper;  
  
    private Counter counter;  
  
    public BookServiceImpl(@Autowired MeterRegistry meterRegistry){  
        counter = meterRegistry.counter("用户付费操作次数：");  
    }  
  
    @Override  
    public boolean delete(Integer id) {  
        //每次执行删除业务等同于执行了付费业务  
        counter.increment();  
        return bookMapper.deleteById(id) > 0;  
    }  
}
```

​在性能指标中就出现了自定义的性能指标监控项

![[监控/附件/image-20220301175101812.png]]

---
# **自定义端点**

​可以根据业务需要自定义端点，方便业务监控

```JAVA
@Component  
@Endpoint(id="pay")  
public class PayEndpoint {  
    @ReadOperation  
    public Object getPay(){  
        Map payMap = new HashMap();  
        payMap.put("level 1","300");  
        payMap.put("level 2","291");  
        payMap.put("level 3","666");  
        return payMap;  
    }  
}
```

​由于此端点数据 spirng boot admin 无法预知该如何展示，所以通过界面无法看到此数据，通过HTTP 请求路径可以获取到当前端点的信息，但是需要先开启当前端点对外功能，或者设置当前端点为默认开发的端点。

![[监控/附件/image-20220301175355482.png]]

> [!NOTE] **总结**
> 
> - 端点的指标可以自定义，但是每种不同的指标根据其功能不同，自定义方式不同
> - info端点通过配置和编程的方式都可以添加端点指标
> - health端点通过编程的方式添加端点指标，需要注意要为对应指标添加启动状态的逻辑设定
> - metrics指标通过在业务中添加监控操作设置指标
> - 可以自定义端点添加更多的指标
